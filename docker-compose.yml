services:
  redis:
    image: "redis:7.0.2"
    restart: always
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    command: "redis-server --save 60 1 --loglevel warning"

  bot:
    build: .
    restart: always
    ports:
      - "127.0.0.1:8443:8443"
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - POKERBOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - POKERBOT_REDIS_HOST=redis
      - POKERBOT_PREFERRED_MODE=webhook
      - POKERBOT_WEBHOOK_LISTEN=0.0.0.0
      - POKERBOT_WEBHOOK_PORT=8443
      - POKERBOT_WEBHOOK_PATH=/telegram/webhook
      - POKERBOT_WEBHOOK_PUBLIC_URL=https://poker.shahin8n.sbs/telegram/webhook
      - POKERBOT_WEBHOOK_SECRET=${POKERBOT_WEBHOOK_SECRET:-}
    depends_on:
      - redis

  webapp-api:
    build:
      context: ./webapp-backend
      dockerfile: Dockerfile
    restart: always
    expose:
      - "8000"
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - WEBAPP_SECRET=${WEBAPP_SECRET}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - POKERBOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - WEBAPP_PUBLIC_ORIGIN=${WEBAPP_PUBLIC_ORIGIN:-https://poker.shahin8n.sbs}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - PYTHONPATH=/app
    volumes:
      # ðŸ”¥ CRITICAL FIX: Share game core with webapp-api
      - ./pokerapp:/app/pokerapp:ro
      - ./translations:/app/translations:ro
    depends_on:
      - redis
      - bot
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request as u; u.urlopen(\"http://127.0.0.1:8000/health\", timeout=5)' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  webapp-frontend:
    build:
      context: ./webapp-frontend
      dockerfile: Dockerfile
      args:
        - WEBAPP_PUBLIC_ORIGIN=${WEBAPP_PUBLIC_ORIGIN:-https://poker.shahin8n.sbs}
        - WEBAPP_API_URL=${WEBAPP_API_URL:-/api}
    restart: always
    ports:
      - "${WEBAPP_FRONTEND_PORT:-8080}:80"
    depends_on:
      webapp-api:
        condition: service_healthy

volumes:
  redis_data:
